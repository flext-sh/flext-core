"""Comprehensive tests for flext_core.models module.

Tests for all model classes, methods, and functionality including factory functions,
semantic validation, serialization, and domain modeling patterns.
"""

from datetime import UTC, datetime

import pytest

# Force import of the module to ensure coverage tracking
import flext_core.models  # noqa: F401
from flext_core import FlextResult
from flext_core.models import (
    # Base models
    FlextBaseModel,
    # Settings
    FlextBaseSettings,
    FlextConnectionType,
    # Configuration models
    FlextDatabaseModel,
    FlextDataFormat,
    # Domain models
    FlextDomainEntity,
    FlextDomainValueObject,
    # TypedDict definitions
    FlextEntityStatus,
    FlextImmutableModel,
    FlextMutableModel,
    FlextOperationModel,
    FlextOperationStatus,
    FlextOracleModel,
    # Service models
    FlextServiceModel,
    # Data integration models
    FlextSingerStreamModel,
    create_database_model,
    create_operation_model,
    create_oracle_model,
    create_service_model,
    create_singer_stream_model,
)


@pytest.mark.unit
class TestFlextEnums:
    """Test enum classes."""

    def test_flext_entity_status_values(self) -> None:
        """Test FlextEntityStatus enum values."""
        assert FlextEntityStatus.ACTIVE == "active"
        assert FlextEntityStatus.INACTIVE == "inactive"
        assert FlextEntityStatus.PENDING == "pending"
        assert FlextEntityStatus.DELETED == "deleted"
        assert FlextEntityStatus.SUSPENDED == "suspended"

    def test_flext_operation_status_values(self) -> None:
        """Test FlextOperationStatus enum values."""
        assert FlextOperationStatus.PENDING == "pending"
        assert FlextOperationStatus.RUNNING == "running"
        assert FlextOperationStatus.COMPLETED == "completed"
        assert FlextOperationStatus.FAILED == "failed"
        assert FlextOperationStatus.CANCELLED == "cancelled"

    def test_flext_data_format_values(self) -> None:
        """Test FlextDataFormat enum values."""
        assert FlextDataFormat.JSON == "json"
        assert FlextDataFormat.XML == "xml"
        assert FlextDataFormat.CSV == "csv"
        assert FlextDataFormat.LDIF == "ldif"
        assert FlextDataFormat.YAML == "yaml"
        assert FlextDataFormat.PARQUET == "parquet"

    def test_flext_connection_type_values(self) -> None:
        """Test FlextConnectionType enum values."""
        assert FlextConnectionType.DATABASE == "database"
        assert FlextConnectionType.REDIS == "redis"
        assert FlextConnectionType.LDAP == "ldap"
        assert FlextConnectionType.ORACLE == "oracle"
        assert FlextConnectionType.REST_API == "rest_api"
        assert FlextConnectionType.GRPC == "grpc"
        assert FlextConnectionType.FILE == "file"


@pytest.mark.unit
class TestFlextBaseModel:
    """Test FlextBaseModel class and methods."""

    def test_base_model_creation(self) -> None:
        """Test basic FlextBaseModel creation."""
        class TestModel(FlextBaseModel):
            name: str = "test"
            value: int = 42

        model = TestModel()
        assert model.name == "test"
        assert model.value == 42

    def test_to_dict_method(self) -> None:
        """Test to_dict method returns model_dump."""
        class TestModel(FlextBaseModel):
            name: str = "test"
            value: int = 42

        model = TestModel()
        result = model.to_dict()

        assert isinstance(result, dict)
        assert result["name"] == "test"
        assert result["value"] == 42

    def test_to_typed_dict_method(self) -> None:
        """Test to_typed_dict method returns model_dump with exclude_unset."""
        class TestModel(FlextBaseModel):
            name: str = "test"
            value: int = 42
            optional: str | None = None

        # Create model with explicit values to ensure they show up in exclude_unset
        model = TestModel(name="explicit_name", value=100)
        result = model.to_typed_dict()

        assert isinstance(result, dict)
        assert "name" in result
        assert "value" in result
        assert result["name"] == "explicit_name"
        assert result["value"] == 100

    def test_validate_semantic_rules_default(self) -> None:
        """Test default validate_semantic_rules returns Ok."""
        class TestModel(FlextBaseModel):
            name: str = "test"

        model = TestModel()
        result = model.validate_semantic_rules()

        assert result.is_success
        assert result.data is None


@pytest.mark.unit
class TestFlextImmutableModel:
    """Test FlextImmutableModel class."""

    def test_immutable_model_creation(self) -> None:
        """Test FlextImmutableModel creation."""
        class TestImmutableModel(FlextImmutableModel):
            name: str
            value: int

        model = TestImmutableModel(name="test", value=42)
        assert model.name == "test"
        assert model.value == 42

    def test_immutable_model_frozen(self) -> None:
        """Test that FlextImmutableModel is frozen."""
        class TestImmutableModel(FlextImmutableModel):
            name: str
            value: int

        model = TestImmutableModel(name="test", value=42)

        # Should not be able to modify fields
        with pytest.raises((AttributeError, ValueError)):
            model.name = "modified"  # type: ignore


@pytest.mark.unit
class TestFlextMutableModel:
    """Test FlextMutableModel class."""

    def test_mutable_model_creation(self) -> None:
        """Test FlextMutableModel creation."""
        class TestMutableModel(FlextMutableModel):
            name: str = "test"
            value: int = 42

        model = TestMutableModel()
        assert model.name == "test"
        assert model.value == 42

    def test_mutable_model_can_modify(self) -> None:
        """Test that FlextMutableModel can be modified."""
        class TestMutableModel(FlextMutableModel):
            name: str = "test"
            value: int = 42

        model = TestMutableModel()
        model.name = "modified"
        model.value = 100

        assert model.name == "modified"
        assert model.value == 100


@pytest.mark.unit
class TestFlextDomainEntity:
    """Test FlextDomainEntity class."""

    def test_domain_entity_creation(self) -> None:
        """Test FlextDomainEntity creation with explicit ID."""
        entity = FlextDomainEntity(id="test-entity-123")

        assert entity.id == "test-entity-123"
        assert entity.status == FlextEntityStatus.ACTIVE
        assert entity.version == 1
        assert isinstance(entity.created_at, datetime)
        assert isinstance(entity.updated_at, datetime)
        assert entity.domain_events == []

    def test_domain_entity_with_custom_id(self) -> None:
        """Test FlextDomainEntity creation with custom ID."""
        entity = FlextDomainEntity(id="custom-id-123")

        assert entity.id == "custom-id-123"
        assert entity.status == FlextEntityStatus.ACTIVE

    def test_domain_entity_hash(self) -> None:
        """Test FlextDomainEntity __hash__ method."""
        entity1 = FlextDomainEntity(id="test-id")
        entity2 = FlextDomainEntity(id="test-id")
        entity3 = FlextDomainEntity(id="different-id")

        # Same ID should have same hash
        assert hash(entity1) == hash(entity2)
        # Different ID should have different hash
        assert hash(entity1) != hash(entity3)

    def test_domain_entity_equality(self) -> None:
        """Test FlextDomainEntity __eq__ method."""
        entity1 = FlextDomainEntity(id="test-id")
        entity2 = FlextDomainEntity(id="test-id")
        entity3 = FlextDomainEntity(id="different-id")

        # Same ID should be equal
        assert entity1 == entity2
        # Different ID should not be equal
        assert entity1 != entity3
        # Different type should not be equal
        assert entity1 != "not-an-entity"

    def test_increment_version(self) -> None:
        """Test increment_version method."""
        entity = FlextDomainEntity()
        original_version = entity.version
        original_updated_at = entity.updated_at

        # Wait a small amount to ensure timestamp changes
        import time
        time.sleep(0.001)

        entity.increment_version()

        assert entity.version == original_version + 1
        assert entity.updated_at > original_updated_at

    def test_add_domain_event(self) -> None:
        """Test add_domain_event method."""
        entity = FlextDomainEntity()

        event1 = {"event_type": "UserCreated", "timestamp": "2025-08-04T12:00:00Z"}
        event2 = {"event_type": "UserUpdated", "field": "email"}

        entity.add_domain_event(event1)
        entity.add_domain_event(event2)

        assert len(entity.domain_events) == 2
        assert entity.domain_events[0] == event1
        assert entity.domain_events[1] == event2


@pytest.mark.unit
class TestFlextDomainValueObject:
    """Test FlextDomainValueObject class."""

    def test_value_object_creation(self) -> None:
        """Test FlextDomainValueObject creation."""
        value_object = FlextDomainValueObject(name="test-value", description="Test description")

        assert value_object.name == "test-value"
        assert value_object.description == "Test description"
        assert isinstance(value_object.created_at, datetime)

    def test_value_object_equality(self) -> None:
        """Test FlextDomainValueObject equality based on all attributes."""
        vo1 = FlextDomainValueObject(name="test", description="desc")
        vo2 = FlextDomainValueObject(name="test", description="desc")
        vo3 = FlextDomainValueObject(name="different", description="desc")

        # Same attributes should be equal (ignoring created_at)
        assert vo1.name == vo2.name
        assert vo1.description == vo2.description

        # Different attributes should not be equal
        assert vo1.name != vo3.name


@pytest.mark.unit
class TestFlextDatabaseModel:
    """Test FlextDatabaseModel configuration."""

    def test_database_model_creation(self) -> None:
        """Test FlextDatabaseModel creation."""
        db_model = FlextDatabaseModel(
            host="localhost",
            port=5432,
            database="test_db",
            username="user",
            password="pass"
        )

        assert db_model.host == "localhost"
        assert db_model.port == 5432
        assert db_model.database == "test_db"
        assert db_model.username == "user"
        assert db_model.password == "pass"
        assert db_model.connection_type == FlextConnectionType.DATABASE

    def test_database_model_connection_string(self) -> None:
        """Test get_connection_string method."""
        db_model = FlextDatabaseModel(
            host="localhost",
            port=5432,
            database="test_db",
            username="user",
            password="pass"
        )

        conn_str = db_model.get_connection_string()
        assert "postgresql://" in conn_str
        assert "localhost:5432" in conn_str
        assert "test_db" in conn_str

    def test_database_model_validate_connection(self) -> None:
        """Test validate_connection method."""
        db_model = FlextDatabaseModel(
            host="localhost",
            port=5432,
            database="test_db",
            username="user",
            password="pass"
        )

        # Should return FlextResult (actual connection test would need real DB)
        result = db_model.validate_connection()
        assert isinstance(result, FlextResult)


@pytest.mark.unit
class TestFlextOracleModel:
    """Test FlextOracleModel configuration."""

    def test_oracle_model_creation(self) -> None:
        """Test FlextOracleModel creation."""
        oracle_model = FlextOracleModel(
            host="oracle.company.com",
            port=1521,
            service_name="ORCL",
            username="hr",
            password="oracle_pass"
        )

        assert oracle_model.host == "oracle.company.com"
        assert oracle_model.port == 1521
        assert oracle_model.service_name == "ORCL"
        assert oracle_model.username == "hr"
        assert oracle_model.password == "oracle_pass"

    def test_oracle_model_connection_string(self) -> None:
        """Test get_connection_string method."""
        oracle_model = FlextOracleModel(
            host="oracle.company.com",
            port=1521,
            service_name="ORCL",
            username="hr",
            password="oracle_pass"
        )

        conn_str = oracle_model.get_connection_string()
        assert "oracle://" in conn_str
        assert "oracle.company.com:1521" in conn_str
        assert "ORCL" in conn_str

    def test_oracle_model_wms_integration(self) -> None:
        """Test Oracle WMS integration settings."""
        oracle_model = FlextOracleModel(
            host="wms-oracle.company.com",
            port=1521,
            service_name="WMS",
            username="wms_user",
            password="wms_pass",
            wms_schema="WMS_PROD"
        )

        assert oracle_model.wms_schema == "WMS_PROD"

        wms_config = oracle_model.get_wms_config()
        assert isinstance(wms_config, dict)
        assert wms_config["schema"] == "WMS_PROD"


@pytest.mark.unit
class TestFlextOperationModel:
    """Test FlextOperationModel for operation tracking."""

    def test_operation_model_creation(self) -> None:
        """Test FlextOperationModel creation."""
        operation = FlextOperationModel(
            operation_id="test-op-001",
            operation_type="ETL_PIPELINE"
        )

        assert operation.operation_id == "test-op-001"
        assert operation.operation_type == "ETL_PIPELINE"
        assert operation.status == FlextOperationStatus.PENDING
        assert operation.progress_percentage == 0.0
        assert operation.max_retries == 3
        assert operation.retry_count == 0

    def test_update_progress(self) -> None:
        """Test update_progress method."""
        operation = FlextOperationModel(
            operation_id="test-op-001",
            operation_type="DATA_SYNC"
        )

        operation.update_progress(45.5, "Processing records")

        assert operation.progress_percentage == 45.5
        assert operation.progress_message == "Processing records"

    def test_mark_completed(self) -> None:
        """Test mark_completed method."""
        operation = FlextOperationModel(
            operation_id="test-op-001",
            operation_type="EXPORT"
        )

        operation.mark_completed()

        assert operation.status == FlextOperationStatus.COMPLETED
        assert operation.progress_percentage == 100.0
        assert operation.completed_at is not None

    def test_mark_failed(self) -> None:
        """Test mark_failed method."""
        operation = FlextOperationModel(
            operation_id="test-op-001",
            operation_type="IMPORT"
        )

        operation.mark_failed("Connection timeout")

        assert operation.status == FlextOperationStatus.FAILED
        assert operation.error_message == "Connection timeout"

    def test_increment_retry_success(self) -> None:
        """Test increment_retry method when retries available."""
        operation = FlextOperationModel(
            operation_id="test-op-001",
            operation_type="SYNC",
            max_retries=2
        )

        # Should succeed since retries are available
        result = operation.increment_retry()
        assert result is True
        assert operation.retry_count == 1
        assert operation.status == FlextOperationStatus.RETRYING

    def test_increment_retry_failure(self) -> None:
        """Test increment_retry method when max retries exceeded."""
        operation = FlextOperationModel(
            operation_id="test-op-001",
            operation_type="BACKUP",
            max_retries=1
        )

        # First retry should succeed
        result1 = operation.increment_retry()
        assert result1 is True
        assert operation.retry_count == 1

        # Second retry should fail (exceeds max_retries)
        result2 = operation.increment_retry()
        assert result2 is False
        assert operation.retry_count == 2


@pytest.mark.unit
class TestFlextSingerStreamModel:
    """Test FlextSingerStreamModel for Singer integration."""

    def test_singer_stream_creation(self) -> None:
        """Test FlextSingerStreamModel creation."""
        stream = FlextSingerStreamModel(
            stream_name="users",
            tap_name="flext-tap-postgres",
            target_name="flext-target-warehouse"
        )

        assert stream.stream_name == "users"
        assert stream.tap_name == "flext-tap-postgres"
        assert stream.target_name == "flext-target-warehouse"
        assert stream.replication_method == "FULL_TABLE"

    def test_get_stream_config(self) -> None:
        """Test get_stream_config method."""
        stream = FlextSingerStreamModel(
            stream_name="orders",
            tap_name="flext-tap-oracle",
            target_name="flext-target-postgres",
            replication_method="INCREMENTAL",
            replication_key="updated_at"
        )

        config = stream.get_stream_config()

        assert isinstance(config, dict)
        assert config["stream_name"] == "orders"
        assert config["replication_method"] == "INCREMENTAL"
        assert config["replication_key"] == "updated_at"

    def test_validate_replication_config(self) -> None:
        """Test validate_replication_config method."""
        # Valid incremental config
        stream = FlextSingerStreamModel(
            stream_name="products",
            tap_name="flext-tap-api",
            target_name="flext-target-json",
            replication_method="INCREMENTAL",
            replication_key="last_modified"
        )

        result = stream.validate_replication_config()
        assert result.is_success


@pytest.mark.unit
class TestFlextServiceModel:
    """Test FlextServiceModel for service discovery."""

    def test_service_model_creation(self) -> None:
        """Test FlextServiceModel creation."""
        service = FlextServiceModel(
            service_name="flext-api",
            service_id="api-01",
            host="api.flext.com",
            port=8080
        )

        assert service.service_name == "flext-api"
        assert service.service_id == "api-01"
        assert service.host == "api.flext.com"
        assert service.port == 8080
        assert service.status == FlextEntityStatus.ACTIVE

    def test_get_service_url(self) -> None:
        """Test get_service_url method."""
        service = FlextServiceModel(
            service_name="flext-auth",
            service_id="auth-01",
            host="auth.flext.com",
            port=9000,
            use_https=True
        )

        url = service.get_service_url()
        assert url == "https://auth.flext.com:9000"

    def test_get_health_check_url(self) -> None:
        """Test get_health_check_url method."""
        service = FlextServiceModel(
            service_name="flext-data",
            service_id="data-01",
            host="data.flext.com",
            port=8081,
            health_check_url="/health"
        )

        health_url = service.get_health_check_url()
        assert health_url == "http://data.flext.com:8081/health"

    def test_register_service(self) -> None:
        """Test register_service method."""
        service = FlextServiceModel(
            service_name="flext-worker",
            service_id="worker-01",
            host="worker.flext.com",
            port=8082
        )

        result = service.register_service()
        assert isinstance(result, FlextResult)

    def test_update_metadata(self) -> None:
        """Test update_metadata method."""
        service = FlextServiceModel(
            service_name="flext-queue",
            service_id="queue-01",
            host="queue.flext.com",
            port=5672
        )

        metadata = {"queue_type": "rabbitmq", "max_connections": 100}
        service.update_metadata(metadata)

        assert service.metadata == metadata


@pytest.mark.unit
class TestFlextBaseSettings:
    """Test FlextBaseSettings class."""

    def test_base_settings_creation(self) -> None:
        """Test FlextBaseSettings creation."""
        class TestSettings(FlextBaseSettings):
            database_url: str = "postgresql://localhost/test"
            debug: bool = False

        settings = TestSettings()
        assert settings.database_url == "postgresql://localhost/test"
        assert settings.debug is False


@pytest.mark.unit
class TestFactoryFunctions:
    """Test factory functions for creating models."""

    def test_create_database_model(self) -> None:
        """Test create_database_model factory function."""
        db_model = create_database_model(
            host="db.example.com",
            port=3306,
            database="app_db",
            username="app_user",
            password="secret"
        )

        assert isinstance(db_model, FlextDatabaseModel)
        assert db_model.host == "db.example.com"
        assert db_model.port == 3306

    def test_create_operation_model(self) -> None:
        """Test create_operation_model factory function."""
        operation = create_operation_model(
            operation_id="batch-001",
            operation_type="BATCH_PROCESS"
        )

        assert isinstance(operation, FlextOperationModel)
        assert operation.operation_id == "batch-001"
        assert operation.operation_type == "BATCH_PROCESS"

    def test_create_oracle_model(self) -> None:
        """Test create_oracle_model factory function."""
        oracle_model = create_oracle_model(
            host="oracle.example.com",
            port=1521,
            service_name="PROD",
            username="oracle_user",
            password="oracle_pass"
        )

        assert isinstance(oracle_model, FlextOracleModel)
        assert oracle_model.host == "oracle.example.com"
        assert oracle_model.service_name == "PROD"

    def test_create_service_model(self) -> None:
        """Test create_service_model factory function."""
        service = create_service_model(
            service_name="test-service",
            service_id="test-01",
            host="service.example.com",
            port=8080
        )

        assert isinstance(service, FlextServiceModel)
        assert service.service_name == "test-service"
        assert service.host == "service.example.com"

    def test_create_singer_stream_model(self) -> None:
        """Test create_singer_stream_model factory function."""
        stream = create_singer_stream_model(
            stream_name="customer_data",
            tap_name="flext-tap-crm",
            target_name="flext-target-warehouse"
        )

        assert isinstance(stream, FlextSingerStreamModel)
        assert stream.stream_name == "customer_data"
        assert stream.tap_name == "flext-tap-crm"


@pytest.mark.integration
class TestModelIntegration:
    """Integration tests between different model types."""

    def test_operation_with_entity_lifecycle(self) -> None:
        """Test operation model integrated with entity lifecycle."""
        # Create operation as domain entity
        operation = FlextOperationModel(
            operation_id="integration-test-001",
            operation_type="DATA_MIGRATION"
        )

        # Test entity behaviors
        operation.add_domain_event({
            "event_type": "OperationStarted",
            "timestamp": datetime.now(UTC).isoformat()
        })

        # Test operation behaviors
        operation.update_progress(25.0, "Migration in progress")
        operation.increment_version()

        assert len(operation.domain_events) == 1
        assert operation.progress == 25.0
        assert operation.version == 2

    def test_service_discovery_with_database_config(self) -> None:
        """Test service model with database configuration."""
        # Create service with database dependency
        service = FlextServiceModel(
            service_name="data-processor",
            service_id="processor-01",
            host="processor.flext.com",
            port=8080
        )

        # Create database config for service
        db_config = FlextDatabaseModel(
            host="db.processor.com",
            port=5432,
            database="processor_db",
            username="processor",
            password="secret"
        )

        # Add database config to service metadata
        service.update_metadata({
            "database_host": db_config.host,
            "database_port": db_config.port,
            "connection_type": db_config.connection_type.value
        })

        assert service.metadata["database_host"] == "db.processor.com"
        assert service.metadata["connection_type"] == "database"

    def test_singer_stream_with_operation_tracking(self) -> None:
        """Test Singer stream model with operation tracking."""
        # Create Singer stream
        stream = FlextSingerStreamModel(
            stream_name="sales_data",
            tap_name="flext-tap-salesforce",
            target_name="flext-target-postgres",
            replication_method="INCREMENTAL",
            replication_key="SystemModstamp"
        )

        # Create operation to track stream processing
        operation = FlextOperationModel(
            operation_id=f"stream-{stream.stream_name}-{datetime.now().strftime('%Y%m%d%H%M%S')}",
            operation_type="STREAM_SYNC"
        )

        # Simulate stream processing
        stream_config = stream.get_stream_config()
        operation.update_progress(50.0, f"Syncing {stream.stream_name}")

        assert stream_config["stream_name"] == "sales_data"
        assert operation.progress == 50.0
        assert "stream-sales_data-" in operation.operation_id
